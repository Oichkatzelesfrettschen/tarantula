````markdown
# Building the 4.4BSD-Lite2 Kernel with a Modern CMake Toolchain

This guide shows how to compile the historic 4.4BSD-Lite2 sources on an x86_64 (or i386 via `-m32`) Linux host using **Clang**, **CMake**, and **Ninja**. It assumes you have root access to install toolchains and that the repository includes the following helper scripts:

- `setup.sh` (installs dependencies, logs to `/tmp/setup.log`)
- `.codex/setup.sh` (CI wrapper, supports `--offline`)

All helper scripts respect the environment variables:

- `SRC_ULAND` → user-land sources (default: `src-uland` or `usr/src/usr.sbin/config`)
- `SRC_KERNEL` → kernel sources (default: `src-kernel` or `usr/src/sys/i386`)

---

## Prerequisites

1. **Run the setup script** as root:
   ```bash
   sudo ./setup.sh
````

* Installs **clang**, **bison**, **cmake**, **ninja**, and other packages.
* If `bison` is missing, the script will warn you; install it manually and rerun.
* On CI, use `.codex/setup.sh --offline` for air-gapped environments.

2. **Verify your environment**:

   ```bash
   clang --version
   bison --version
   cmake --version
   ninja --version
   ```

3. **Ensure** `SRC_ULAND` and `SRC_KERNEL` point where your source trees live:

   ```bash
   export SRC_ULAND=${SRC_ULAND:-src-uland}
   export SRC_KERNEL=${SRC_KERNEL:-src-kernel}
   ```

4. **Baseline toolchain flags**
   The CMake toolchain unconditionally applies:

   ```text
   -march=x86-64-v1 -msse2 -mmmx -mfpmath=sse
   -O3 -fuse-ld=lld
   ```

   for maximum compatibility and performance on modern 64-bit hardware.

---

## 1 · Build the `config` Utility

```bash
cmake \
  -S ${SRC_ULAND}/usr.sbin/config \
  -B build/config \
  -G Ninja

cmake --build build/config
```

* Produces `build/config/config`
* This binary generates the per-kernel-variant build directories.

---

## 2 · Generate the Kernel Configuration

```bash
cd ${SRC_KERNEL}/sys/i386/conf
../../build/config/config GENERIC.i386
```

* Creates `../compile/GENERIC.i386` (or similar) with all `Makefile` fragments in place.

---

## 3 · Configure & Build the Kernel

```bash
cmake \
  -S ${SRC_KERNEL}/compile/GENERIC.i386 \
  -B build/kernel \
  -G Ninja \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_C_STANDARD=23 \
  -DCMAKE_C_FLAGS='-O3 -fuse-ld=lld' \
  -DCMAKE_CXX_FLAGS='-O3 -fuse-ld=lld' \
  -DLLVM_ENABLE_LTO=ON

ninja -C build/kernel
```

* **Optional**: add `-DLLVM_ENABLE_POLLY=ON` or run `llvm-bolt` on the resulting kernel binary for advanced profile-guided or polyhedral optimizations.

---

## 4 · Build User-Space Components

Each service under `${SRC_ULAND}` gets its own CMake directory:

```bash
cmake \
  -S ${SRC_ULAND}/servers/fs \
  -B build/fs \
  -G Ninja

cmake --build build/fs
```

* Install with `cmake --install build/fs --prefix /usr/libexec` or your preferred root.

---

## 5 · Run Kernel Self-Tests

A lightweight test suite exercises kernel stubs without needing to boot:

```bash
cmake \
  -S tests \
  -B build/tests \
  -G Ninja

cmake --build build/tests

./build/tests/test_kern  # should print “all ok”
```

---

## 6 · Legacy Makefile Support

The repository still includes a classic `Makefile` in `tests/`. To use it:

1. **Build the static libs** via CMake:

   ```bash
   cmake -S . -B build -G Ninja
   cmake --build build --target ipc posix kern_stubs
   ```
2. **Invoke the legacy Make**:

   ```bash
   make -C tests
   ```

---

## 7 · Cleaning Up

Before committing, remove all generated build artifacts:

```bash
# remove all Ninja/CMake build trees
rm -rf build/

# remove any per-variant directories generated by config
rm -rf ${SRC_KERNEL}/sys/i386/compile/*

# confirm with Git
git clean -fdx
```

Keeping the repository free of temporary files prevents merge conflicts and ensures patches remain concise.

---